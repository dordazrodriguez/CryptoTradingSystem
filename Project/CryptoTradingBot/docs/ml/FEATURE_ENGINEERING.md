# Feature Engineering Documentation

This document provides a comprehensive breakdown of all 170 features generated by the ML feature engineering pipeline for the Crypto Trading Bot.

## Overview

The feature engineering system (`ml_models/features.py`) creates a comprehensive set of features from raw OHLCV (Open, High, Low, Close, Volume) data. These features are organized into six main categories:

1. **Price Features** (47 features)
2. **Volume Features** (24 features)
3. **Technical Features** (29 features)
4. **Time Features** (18 features)
5. **Lag Features** (12 features)
6. **Interaction Features** (6 features)

**Total: 136 new features** + **6 original columns** (OHLCV + timestamp) = **~173 total features**

---

## 1. Price Features (47 features)

### Basic Price Features (3)
- `price_change`: Percentage change in close price
- `price_change_abs`: Absolute value of price change
- `log_return`: Natural logarithm of price ratio (log(close/close_prev))

### Momentum Features (18 features)
For windows [1, 2, 3, 5, 10, 20]:
- `momentum_{window}`: Price momentum over N periods (close/close_N_periods_ago - 1)
- `roc_{window}`: Rate of change (percentage change over N periods)
- `price_acceleration_{window}`: Change in momentum (first derivative)

### Volatility Features (12 features)
For windows [5, 10, 20, 50]:
- `volatility_{window}`: Rolling standard deviation of price changes
- `volatility_ratio_{window}`: Current volatility / long-term average volatility
- `price_range_{window}`: (Max high - Min low) / Close price over window

### Price Position Features (6 features)
For windows [10, 20, 50]:
- `price_position_{window}`: Position within range (0=bottom, 1=top)
- `price_percentile_{window}`: Percentile rank of current price within window

### Gap Features (3 features)
- `gap_up`: Binary indicator if open > previous close
- `gap_down`: Binary indicator if open < previous close
- `gap_size`: Size of gap as percentage of previous close

### Intraday Features (5 features)
- `intraday_return`: (Close - Open) / Open
- `intraday_volatility`: (High - Low) / Open
- `body_size`: Absolute value of (Close - Open) / Open
- `upper_shadow`: (High - max(Open, Close)) / Open
- `lower_shadow`: (min(Open, Close) - Low) / Open

---

## 2. Volume Features (24 features)

### Basic Volume Features (3)
- `volume_change`: Percentage change in volume
- `volume_change_abs`: Absolute value of volume change
- `log_volume`: Natural logarithm of volume (log(volume + 1))

### Volume Moving Averages (12 features)
For windows [5, 10, 20, 50]:
- `volume_sma_{window}`: Simple moving average of volume
- `volume_ema_{window}`: Exponential moving average of volume
- `volume_ratio_{window}`: Current volume / SMA volume

### Volume Volatility (2 features)
For windows [10, 20]:
- `volume_volatility_{window}`: Rolling standard deviation of volume changes

### Volume-Price Relationship (3 features)
- `volume_price_trend`: Price change × Volume change (confirms trends)
- `volume_weighted_price`: VWAP (Volume-Weighted Average Price) over 20 periods
- `vwap_deviation`: (Close - VWAP) / VWAP

### Volume Patterns (2 features)
- `volume_spike`: Binary indicator if volume > 2× average
- `volume_dry_up`: Binary indicator if volume < 0.5× average

### On-Balance Volume (2 features)
- `obv`: Cumulative On-Balance Volume indicator
- `obv_change`: Percentage change in OBV

---

## 3. Technical Features (29 features)

### Moving Averages (28 features)
For windows [5, 10, 12, 20, 26, 50, 200]:
- `sma_{window}`: Simple Moving Average
- `ema_{window}`: Exponential Moving Average
- `price_sma_ratio_{window}`: Close / SMA (distance from average)
- `price_ema_ratio_{window}`: Close / EMA (distance from average)

### Moving Average Crossovers (3 features)
- `sma_cross_5_20`: Binary if SMA(5) > SMA(20)
- `sma_cross_10_50`: Binary if SMA(10) > SMA(50)
- `ema_cross_12_26`: Binary if EMA(12) > EMA(26) (MACD-like)

### RSI (Relative Strength Index) (4 features)
- `rsi`: RSI value (0-100, typically 14-period)
- `rsi_oversold`: Binary indicator if RSI < 30
- `rsi_overbought`: Binary indicator if RSI > 70
- `rsi_divergence`: Detected divergence between price and RSI trends

### MACD (Moving Average Convergence Divergence) (4 features)
- `macd`: MACD line (EMA(12) - EMA(26))
- `macd_signal`: Signal line (EMA of MACD, typically 9-period)
- `macd_histogram`: MACD - Signal (histogram)
- `macd_cross`: Binary indicator if MACD > Signal

### Bollinger Bands (6 features)
- `bb_upper`: Upper Bollinger Band (MA + 2×StdDev)
- `bb_middle`: Middle line (Moving Average)
- `bb_lower`: Lower Bollinger Band (MA - 2×StdDev)
- `bb_width`: Band width normalized by price
- `bb_position`: Position within bands (0=lower, 1=upper)
- `bb_squeeze`: Binary indicator for volatility squeeze (width < 50% of average)

### Stochastic Oscillator (4 features)
- `stoch_k`: %K line (stochastic oscillator)
- `stoch_d`: %D line (moving average of %K)
- `stoch_oversold`: Binary if both K and D < 20
- `stoch_overbought`: Binary if both K and D > 80

---

## 4. Time Features (18 features)

### Time Components (6 features)
- `hour`: Hour of day (0-23)
- `minute`: Minute of hour (0-59)
- `day_of_week`: Day of week (0=Monday, 6=Sunday)
- `day_of_month`: Day of month (1-31)
- `month`: Month (1-12)
- `quarter`: Quarter (1-4)

### Cyclical Encoding (6 features)
Cyclical encoding for time periods (sin/cos pairs for smooth transitions):
- `hour_sin`: sin(2π × hour / 24)
- `hour_cos`: cos(2π × hour / 24)
- `minute_sin`: sin(2π × minute / 60)
- `minute_cos`: cos(2π × minute / 60)
- `day_sin`: sin(2π × day_of_week / 7)
- `day_cos`: cos(2π × day_of_week / 7)

### Market Session Features (5 features)
- `is_weekend`: Binary indicator if day is Saturday or Sunday
- `is_market_open`: Binary if hour is between 9 and 16
- `is_lunch_time`: Binary if hour is between 12 and 13
- `is_end_of_day`: Binary if hour >= 15
- `minutes_since_open`: Minutes since market open (9 AM)

### Timestamp Column (1 feature)
- `timestamp`: Normalized timestamp column (created if not present)

---

## 5. Lag Features (12 features)

### Lagged Price Values (6 features)
For lags [1, 2, 3, 5, 10, 20]:
- `close_lag_{lag}`: Close price N periods ago

### Lagged Percentage Changes (6 features)
For lags [1, 2, 3, 5, 10, 20]:
- `close_pct_change_lag_{lag}`: Percentage change from N periods ago

These features capture historical price information that helps models understand price trends and momentum patterns.

---

## 6. Interaction Features (6 features)

Interaction features capture relationships between different indicators:

### Price-Volume Interactions (2 features)
- `price_volume_interaction`: Price change × Volume change
- `price_volume_abs_interaction`: |Price change| × |Volume change|

### RSI-MACD Interactions (2 features)
- `rsi_macd_interaction`: RSI × MACD (combined momentum signal)
- `rsi_macd_divergence`: Binary indicator for RSI/MACD divergence patterns

### Bollinger Band Interactions (1 feature)
- `bb_position_width_interaction`: Position within bands × Band width

### Volatility-Momentum Interactions (1 feature)
- `volatility_momentum_interaction`: Volatility × |Momentum|

---

## Feature Engineering Pipeline

The feature engineering process follows this sequence:

1. **Price Features** → Creates 47 features from OHLC data
2. **Volume Features** → Creates 24 features from volume data
3. **Technical Features** → Creates 29 features from technical indicators
4. **Time Features** → Creates 18 features from timestamp data
5. **Lag Features** → Creates 12 features from historical price data
6. **Interaction Features** → Creates 6 features from combined indicators

### Data Cleaning

After feature creation, the pipeline:
- Forward fills missing values (carries last known value forward)
- Backward fills remaining NaNs (fills initial values)
- Fills any remaining NaNs with 0
- Removes rows with NaN in critical columns (timestamp, close) only if necessary

### Feature Selection

The `MLFeatureEngineer` class includes a `select_features()` method that:
- Uses statistical tests (F-regression) to rank feature importance
- Selects top K features based on correlation with target variable
- Helps reduce dimensionality and avoid overfitting

---

## Usage Example

```python
from ml_models.features import MLFeatureEngineer

# Initialize feature engineer
feature_engineer = MLFeatureEngineer()

# Create all features from OHLCV data
featured_data = feature_engineer.create_all_features(df)

# Result: DataFrame with ~173 features
print(f"Total features: {len(featured_data.columns)}")
```

---

## Log Output Interpretation

When running the feature engineering pipeline, you'll see log messages like:

```
INFO - Created 47 price features
INFO - Created 24 volume features
INFO - Created 29 technical features
INFO - Created 18 time features
INFO - Created 12 lag features
INFO - Created 6 interaction features
INFO - Feature engineering complete: 173 features, 0 rows removed, 1000 rows available
```

This indicates:
- Each category of features created
- Total number of features (including original columns)
- Number of rows removed (only if critical columns had NaN)
- Final number of rows available for ML training

---

## Performance Considerations

- **Computational Cost**: Feature engineering adds ~136 new columns, which increases memory usage
- **Window Sizes**: Uses various rolling windows (1-200 periods) which require historical data
- **NaN Handling**: Initial rows may have NaN values due to rolling calculations; handled via forward/backward fill
- **Feature Scaling**: Consider using `scale_features()` method before training models
- **Feature Selection**: Use `select_features()` to reduce dimensionality for faster training

---

## Notes

- All features are calculated incrementally as new data arrives
- Technical indicators are recalculated using the most recent data
- Lag features require sufficient historical data (up to 20 periods)
- Time features assume UTC or normalized timestamps
- Interaction features are conditional (only created if prerequisite features exist)

